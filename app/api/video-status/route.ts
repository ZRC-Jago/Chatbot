import { VIDEO_GENERATION_MODEL } from "@/lib/models"

const SILICONFLOW_API_KEY = process.env.SILICONFLOW_API_KEY

if (!SILICONFLOW_API_KEY) {
  console.error("[v0] SILICONFLOW_API_KEY ç¯å¢ƒå˜é‡æœªé…ç½®")
}

export async function POST(req: Request) {
  try {
    const { requestId } = await req.json()

    console.log("========================================")
    console.log("ğŸ¬ [è§†é¢‘çŠ¶æ€API] æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€")
    console.log("  - RequestId:", requestId)
    console.log("========================================")

    if (!requestId) {
      return new Response(
        JSON.stringify({ error: "requestId is required" }),
        {
          status: 400,
          headers: { "Content-Type": "application/json" },
        }
      )
    }

    // æ£€æŸ¥ API Key æ˜¯å¦é…ç½®
    if (!SILICONFLOW_API_KEY) {
      console.error("[v0] SILICONFLOW_API_KEY æœªé…ç½®")
      return new Response(
        JSON.stringify({ 
          error: "SiliconFlow API Key æœªé…ç½®ã€‚è¯·åœ¨ .env.local æ–‡ä»¶ä¸­æ·»åŠ  SILICONFLOW_API_KEY=ä½ çš„APIå¯†é’¥" 
        }),
        {
          status: 500,
          headers: { "Content-Type": "application/json" },
        }
      )
    }

    // è°ƒç”¨ SiliconFlow è§†é¢‘çŠ¶æ€æŸ¥è¯¢ API
    const response = await fetch("https://api.siliconflow.cn/v1/video/status", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${SILICONFLOW_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        requestId: requestId,
      }),
    })

    console.log("[v0] è§†é¢‘çŠ¶æ€API: å“åº”çŠ¶æ€:", response.status)

    if (!response.ok) {
      const errorText = await response.text()
      console.error("[v0] è§†é¢‘çŠ¶æ€API: é”™è¯¯:", errorText)
      return new Response(
        JSON.stringify({ 
          error: `Failed to query video status: ${response.status} - ${errorText}` 
        }),
        {
          status: response.status,
          headers: { "Content-Type": "application/json" },
        }
      )
    }

    const data = await response.json()
    console.log("[v0] è§†é¢‘çŠ¶æ€API: å“åº”æ•°æ®:", JSON.stringify(data, null, 2))

    return new Response(
      JSON.stringify(data),
      {
        status: 200,
        headers: { "Content-Type": "application/json" },
      }
    )
  } catch (error) {
    console.error("[v0] è§†é¢‘çŠ¶æ€API: é”™è¯¯:", error)
    return new Response(
      JSON.stringify({ 
        error: error instanceof Error ? error.message : "Failed to query video status" 
      }),
      {
        status: 500,
        headers: { "Content-Type": "application/json" },
      }
    )
  }
}
